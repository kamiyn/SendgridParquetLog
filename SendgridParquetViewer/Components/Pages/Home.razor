@page "/"
@rendermode InteractiveServer
@using Microsoft.FluentUI.AspNetCore.Components
@using SendgridParquetViewer.Models
@using SendgridParquetViewer.Services
@inject DuckDbService DuckDbService

<PageTitle>SendGrid Events Viewer</PageTitle>

<h1>SendGrid Events Viewer</h1>

<div style="padding: 20px; background-color: #f8f9fa; border-radius: 8px; margin-bottom: 20px;">
    <h3>検索条件</h3>
    
    <!-- Search Form with Flow Layout -->
    <FluentStack Orientation="Orientation.Horizontal" Wrap="true" Style="gap: 20px; align-items: flex-start;">
        
        <!-- Email Address Field -->
        <div style="min-width: 250px;">
            <FluentTextField @bind-Value="_selectedEmail" @oninput="OnInputChange" Label="email（LIKE句）" Style="width: 100%;" Placeholder="example@domain.com" />
        </div>
        
        <!-- Date Selection Mode -->
        <div style="min-width: 250px;">
            <FluentLabel>日付の扱い</FluentLabel>
            <FluentRadioGroup @bind-Value="_dateSelectionMode" @onchange="OnDateSelectionModeChange" Style="margin-top: 5px;">
                <FluentRadio Value="@DateSelectionMode.YearMonth">年月のみ使用（日付は無視）</FluentRadio>
                <FluentRadio Value="@DateSelectionMode.YearMonthDay">年月日すべて使用</FluentRadio>
            </FluentRadioGroup>
        </div>
        
        <!-- Date Picker - Always Visible -->
        <div style="min-width: 200px;">
            <FluentDatePicker @bind-Value="_selectedDate" @oninput="OnInputChange" Label="日付選択" Style="width: 100%;" />
            @if (_dateSelectionMode == DateSelectionMode.YearMonth)
            {
                <small style="color: #666; margin-top: 5px; display: block;">※ 日付部分は検索で無視されます</small>
            }
        </div>
        
        <!-- Search Button -->
        <div style="margin-top: 25px;">
            <FluentButton Appearance="Appearance.Accent" OnClick="SearchAsync">検索</FluentButton>
        </div>
        
    </FluentStack>
</div>

@if (!string.IsNullOrEmpty(_errorMessage))
{
    <FluentMessageBar Intent="MessageIntent.Error" Style="margin-bottom: 20px;">
        <div>
            <strong>エラー:</strong> @_errorMessage
        </div>
    </FluentMessageBar>
}

@if (_isLoading)
{
    <FluentProgress />
    <p>データを検索中...</p>
}
else if (_sendGridEvents.Any())
{
    <div style="margin-top: 10px;">
        <p>検索結果: @_sendGridEvents.Count 件</p>
        
        <FluentDataGrid Items="@_sendGridEvents.AsQueryable()" Pagination="@_pagination">
            <PropertyColumn Property="@(e => e.Timestamp)" Title="タイムスタンプ" Format="yyyy-MM-dd HH:mm:ss" Sortable="true" />
            <PropertyColumn Property="@(e => e.Email)" Title="メールアドレス" Sortable="true" />
            <PropertyColumn Property="@(e => e.Event)" Title="イベント" Sortable="true" />
            <PropertyColumn Property="@(e => e.Category)" Title="カテゴリ" Sortable="true" />
            <PropertyColumn Property="@(e => e.Reason)" Title="理由" />
            <PropertyColumn Property="@(e => e.Status)" Title="ステータス" />
            <PropertyColumn Property="@(e => e.Response)" Title="レスポンス" />
            <PropertyColumn Property="@(e => e.MarketingCampaignName)" Title="キャンペーン名" Sortable="true" />
            <PropertyColumn Property="@(e => e.Url)" Title="URL" />
            <PropertyColumn Property="@(e => e.UserAgent)" Title="ユーザーエージェント" />
            <PropertyColumn Property="@(e => e.Ip)" Title="IPアドレス" />
        </FluentDataGrid>
        
        <FluentPaginator State="@_pagination" />
    </div>
}
else if (_hasSearched)
{
    <p>検索結果が見つかりませんでした。</p>
}

@code {
    // Enum for date selection mode
    public enum DateSelectionMode
    {
        YearMonth,
        YearMonthDay
    }
    
    private IList<SendGridEvent> _sendGridEvents = [];
    private bool _isLoading;
    private bool _hasSearched;
    private string _errorMessage = "";
    
    // Search parameters
    private string _selectedEmail = "";
    private DateSelectionMode _dateSelectionMode = DateSelectionMode.YearMonth;
    private DateTime? _selectedDate = DateTime.Now;
    
    private readonly PaginationState _pagination = new PaginationState { ItemsPerPage = 50 };

    private void OnInputChange()
    {
        // Reset search state when any input changes
        _hasSearched = false;
        _errorMessage = "";
    }
    
    private void OnDateSelectionModeChange()
    {
        // Reset search state when date selection mode changes
        OnInputChange();
    }

    private async Task SearchAsync()
    {
        // Clear previous error message
        _errorMessage = "";
        await ExecuteSearchAsync(DetermineSearchMethod());
    }

    private Func<Task<IList<SendGridEvent>>> DetermineSearchMethod()
    {
        bool hasEmail = !string.IsNullOrWhiteSpace(_selectedEmail);
        bool hasDate = _selectedDate.HasValue;

        return (hasEmail, hasDate, dateSelectionMode: _dateSelectionMode) switch
        {
            // Email + Date search (Year-Month mode - ignore day)
            (true, true, DateSelectionMode.YearMonth) => async () => await DuckDbService.GetEventsByEmailAndMonthAsync(
                _selectedEmail, _selectedDate!.Value.Year, _selectedDate!.Value.Month),
            
            // Email + Date search (Year-Month-Day mode - use full date for month search)
            (true, true, DateSelectionMode.YearMonthDay) => async () => await DuckDbService.GetEventsByEmailAndMonthAsync(
                _selectedEmail, _selectedDate!.Value.Year, _selectedDate!.Value.Month),
            
            // Date search only (Year-Month-Day mode - use full date)
            (false, true, DateSelectionMode.YearMonthDay) => async () => await DuckDbService.GetEventsByDateAsync(
                _selectedDate!.Value.Year, _selectedDate!.Value.Month, _selectedDate!.Value.Day),
            
            // Date search only (Year-Month mode - ignore day)
            (false, true, DateSelectionMode.YearMonth) => async () => await DuckDbService.GetEventsByMonthAsync(
                _selectedDate!.Value.Year, _selectedDate!.Value.Month),
            
            // No valid search criteria
            _ => HandleInvalidSearchCriteria()
        };
    }

    private Func<Task<IList<SendGridEvent>>> HandleInvalidSearchCriteria()
    {
        _errorMessage = "検索条件を指定してください: 日付を選択し、必要に応じてメールアドレスを入力してください";
        return () => Task.FromResult<IList<SendGridEvent>>([]);
    }

    private async Task ExecuteSearchAsync(Func<Task<IList<SendGridEvent>>> searchFunc)
    {
        _isLoading = true;
        _sendGridEvents = [];
        try
        {
            _sendGridEvents = await searchFunc();
        }
        catch (Exception ex)
        {
            _errorMessage = $"検索中にエラーが発生しました: {ex.Message}";
        }
        finally
        {
            _isLoading = false;
            _hasSearched = true;
            StateHasChanged(); // Force UI update
        }
    }
}
