@page "/"
@rendermode InteractiveServer
@using Microsoft.FluentUI.AspNetCore.Components
@using SendgridParquetViewer.Models
@using SendgridParquetViewer.Services
@inject DuckDbService DuckDbService

<PageTitle>SendGrid Events Viewer</PageTitle>

<h1>SendGrid Events Viewer</h1>

<div style="padding: 20px; background-color: #f8f9fa; border-radius: 8px; margin-bottom: 20px;">
    <h3>検索条件</h3>
    <FluentStack Orientation="Orientation.Horizontal" Wrap="true" Style="gap: 15px;">
        <FluentTextField @bind-Value="selectedEmail" @oninput="OnInputChange" Label="メールアドレス（オプション）" Style="width: 250px;" Placeholder="example@domain.com" />
        <FluentNumberField @bind-Value="selectedYear" @oninput="OnInputChange" Label="年（オプション）" Style="width: 120px;" Placeholder="2025" />
        <FluentNumberField @bind-Value="selectedMonth" @oninput="OnInputChange" Label="月（オプション）" Style="width: 120px;" Placeholder="8" />
        <FluentNumberField @bind-Value="selectedDay" @oninput="OnInputChange" Label="日（オプション）" Style="width: 120px;" Placeholder="29" />
        <FluentButton Appearance="Appearance.Accent" OnClick="SearchAsync" Style="margin-top: 20px;">検索</FluentButton>
    </FluentStack>
</div>

@if (!string.IsNullOrEmpty(errorMessage))
{
    <FluentMessageBar Intent="MessageIntent.Error" Style="margin-bottom: 20px;">
        <div>
            <strong>エラー:</strong> @errorMessage
        </div>
    </FluentMessageBar>
}

@if (isLoading)
{
    <FluentProgress />
    <p>データを検索中...</p>
}
else if (sendGridEvents.Any())
{
    <div style="margin-top: 10px;">
        <p>検索結果: @sendGridEvents.Count 件</p>
        
        <FluentDataGrid Items="@sendGridEvents.AsQueryable()" Pagination="@pagination">
            <PropertyColumn Property="@(e => e.Timestamp)" Title="タイムスタンプ" Format="yyyy-MM-dd HH:mm:ss" Sortable="true" />
            <PropertyColumn Property="@(e => e.Email)" Title="メールアドレス" Sortable="true" />
            <PropertyColumn Property="@(e => e.Event)" Title="イベント" Sortable="true" />
            <PropertyColumn Property="@(e => e.Category)" Title="カテゴリ" Sortable="true" />
            <PropertyColumn Property="@(e => e.Reason)" Title="理由" />
            <PropertyColumn Property="@(e => e.Status)" Title="ステータス" />
            <PropertyColumn Property="@(e => e.Response)" Title="レスポンス" />
            <PropertyColumn Property="@(e => e.MarketingCampaignName)" Title="キャンペーン名" Sortable="true" />
            <PropertyColumn Property="@(e => e.Url)" Title="URL" />
            <PropertyColumn Property="@(e => e.UserAgent)" Title="ユーザーエージェント" />
            <PropertyColumn Property="@(e => e.Ip)" Title="IPアドレス" />
        </FluentDataGrid>
        
        <FluentPaginator State="@pagination" />
    </div>
}
else if (hasSearched)
{
    <p>検索結果が見つかりませんでした。</p>
}

@code {
    private IList<SendGridEvent> sendGridEvents = [];
    private bool isLoading = false;
    private bool hasSearched = false;
    private string errorMessage = "";
    
    // Search parameters - nullable to allow optional input
    private int? selectedYear = null;
    private int? selectedMonth = null;
    private int? selectedDay = null;
    private string selectedEmail = "";
    
    private PaginationState pagination = new PaginationState { ItemsPerPage = 50 };

    private void OnInputChange()
    {
        // Reset search state when any input changes
        hasSearched = false;
        errorMessage = "";
    }

    private async Task SearchAsync()
    {
        // Clear previous error message
        errorMessage = "";
        
        // Determine which search method to use based on input state
        Func<Task<IList<SendGridEvent>>>? searchFunc = DetermineSearchMethod();
        
        if (searchFunc != null)
        {
            await ExecuteSearchAsync(searchFunc);
        }
    }

    private Func<Task<IList<SendGridEvent>>> DetermineSearchMethod()
    {
        bool hasEmail = !string.IsNullOrWhiteSpace(selectedEmail);
        bool hasYear = selectedYear.HasValue;
        bool hasMonth = selectedMonth.HasValue;
        bool hasDay = selectedDay.HasValue;

        return (hasEmail, hasYear, hasMonth, hasDay) switch
        {
            // Email + Year + Month search
            (true, true, true, _) => async () => await DuckDbService.GetEventsByEmailAndMonthAsync(selectedEmail!, selectedYear!.Value, selectedMonth!.Value),
            
            // Specific date search (Year + Month + Day)
            (false, true, true, true) => async () => await DuckDbService.GetEventsByDateAsync(selectedYear!.Value, selectedMonth!.Value, selectedDay!.Value),
            
            // Month search (Year + Month only)
            (false, true, true, false) => async () => await DuckDbService.GetEventsByMonthAsync(selectedYear!.Value, selectedMonth!.Value, 1000),
            
            // No valid search criteria
            _ => HandleInvalidSearchCriteria()
        };
    }

    private Func<Task<IList<SendGridEvent>>> HandleInvalidSearchCriteria()
    {
        errorMessage = "検索条件を指定してください: 年+月、年+月+日、またはメールアドレス+年+月";
        return () => Task.FromResult<IList<SendGridEvent>>([]);
    }

    private async Task ExecuteSearchAsync(Func<Task<IList<SendGridEvent>>> searchFunc)
    {
        isLoading = true;
        sendGridEvents = [];
        try
        {
            sendGridEvents = await searchFunc();
        }
        catch (Exception ex)
        {
            errorMessage = $"検索中にエラーが発生しました: {ex.Message}";
        }
        finally
        {
            isLoading = false;
            hasSearched = true;
            StateHasChanged(); // Force UI update
        }
    }
}
