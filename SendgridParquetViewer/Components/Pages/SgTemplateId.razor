@page "/sg_template_id/{TemplateId}"
@rendermode InteractiveServer
@attribute [Authorize]
@using SendgridParquetViewer.Models
@using SendgridParquetViewer.Services
@inject ISendgridTemplateService SendgridTemplateService
@inject ILogger<SgTemplateId> Logger

<PageTitle>SendGrid Template - @TemplateId</PageTitle>

<h1>SendGrid Template</h1>

<style>
    .template-section + .template-section {
        margin-top: 2rem;
    }

    .template-table {
        border-collapse: collapse;
        border: 1px solid #d0d7de;
        min-width: 320px;
        margin-top: 0.5rem;
    }

    .template-table th,
    .template-table td {
        border: 1px solid #d0d7de;
        padding: 0.5rem 0.75rem;
        text-align: left;
        vertical-align: top;
    }

    .template-table th {
        background-color: #f6f8fa;
        font-weight: 600;
        width: 180px;
    }

    .template-preview-container {
        border: 1px solid #d0d7de;
        border-radius: 4px;
        margin-top: 1rem;
        background-color: #fff;
    }

    .template-preview-header {
        background-color: #f6f8fa;
        padding: 0.5rem 0.75rem;
        border-bottom: 1px solid #d0d7de;
        font-weight: 600;
    }

    .template-preview-iframe {
        width: 100%;
        height: 600px;
        border: none;
    }

    .template-plain-content {
        white-space: pre-wrap;
        font-family: monospace;
        background-color: #f6f8fa;
        padding: 1rem;
        border-radius: 4px;
        max-height: 400px;
        overflow-y: auto;
    }

    .template-error {
        color: #d73a49;
        background-color: #ffeef0;
        padding: 1rem;
        border-radius: 4px;
        margin-top: 1rem;
    }

    .template-loading {
        color: #6a737d;
        padding: 1rem;
    }
</style>

@if (_isLoading)
{
    <div class="template-loading">
        <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
        <span>テンプレート情報を取得中...</span>
    </div>
}
else if (!string.IsNullOrEmpty(_errorMessage))
{
    <div class="template-error">
        <strong>エラー:</strong> @_errorMessage
    </div>
}
else if (_template != null)
{
    <section class="template-section">
        <h2>テンプレート情報</h2>
        <table class="template-table">
            <tbody>
                <tr>
                    <th>Template ID</th>
                    <td>@_template.Id</td>
                </tr>
                <tr>
                    <th>名前</th>
                    <td>@_template.Name</td>
                </tr>
                <tr>
                    <th>Generation</th>
                    <td>@_template.Generation</td>
                </tr>
                <tr>
                    <th>更新日時</th>
                    <td>@_template.Updated_At</td>
                </tr>
            </tbody>
        </table>
    </section>

    @if (_activeVersion != null)
    {
        <section class="template-section">
            <h2>アクティブバージョン</h2>
            <table class="template-table">
                <tbody>
                    <tr>
                        <th>Version ID</th>
                        <td>@_activeVersion.Id</td>
                    </tr>
                    <tr>
                        <th>バージョン名</th>
                        <td>@_activeVersion.Name</td>
                    </tr>
                    <tr>
                        <th>件名 (Subject)</th>
                        <td>@_activeVersion.Subject</td>
                    </tr>
                    <tr>
                        <th>エディタ</th>
                        <td>@_activeVersion.Editor</td>
                    </tr>
                    <tr>
                        <th>更新日時</th>
                        <td>@_activeVersion.Updated_At</td>
                    </tr>
                </tbody>
            </table>
        </section>

        @if (!string.IsNullOrEmpty(_activeVersion.Html_Content))
        {
            <section class="template-section">
                <h2>HTML プレビュー</h2>
                <div class="template-preview-container">
                    <div class="template-preview-header">HTML Content</div>
                    <iframe class="template-preview-iframe" srcdoc="@_activeVersion.Html_Content" sandbox="allow-same-origin"></iframe>
                </div>
            </section>
        }

        @if (!string.IsNullOrEmpty(_activeVersion.Plain_Content))
        {
            <section class="template-section">
                <h2>Plain Text</h2>
                <div class="template-plain-content">@_activeVersion.Plain_Content</div>
            </section>
        }

        @if (!string.IsNullOrEmpty(_activeVersion.Test_Data))
        {
            <section class="template-section">
                <h2>Test Data</h2>
                <div class="template-plain-content">@_activeVersion.Test_Data</div>
            </section>
        }
    }
    else
    {
        <section class="template-section">
            <div class="template-error">
                <strong>注意:</strong> アクティブなバージョンが見つかりませんでした。
            </div>
        </section>
    }
}

@code {
    [Parameter]
    public string TemplateId { get; set; } = string.Empty;

    private bool _isLoading = true;
    private string _errorMessage = string.Empty;
    private SendgridTemplateItemResult? _template;
    private SendgridTemplateItemVersion? _activeVersion;

    protected override async Task OnInitializedAsync()
    {
        await LoadTemplateAsync();
    }

    private async Task LoadTemplateAsync()
    {
        _isLoading = true;
        _errorMessage = string.Empty;

        try
        {
            if (string.IsNullOrWhiteSpace(TemplateId))
            {
                _errorMessage = "テンプレートIDが指定されていません。";
                return;
            }

            _template = await SendgridTemplateService.GetSendgridTemplateItemAsync(TemplateId, CancellationToken.None);

            if (_template == null)
            {
                _errorMessage = $"テンプレート '{TemplateId}' の取得に失敗しました。APIキーの設定を確認してください。";
                return;
            }

            // Active = 1 のバージョンを取得
            _activeVersion = _template.Versions.FirstOrDefault(v => v.Active == 1);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to load template: {TemplateId}", TemplateId);
            _errorMessage = $"テンプレートの取得中にエラーが発生しました: {ex.Message}";
        }
        finally
        {
            _isLoading = false;
        }
    }
}
