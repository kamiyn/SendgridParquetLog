@page "/histogram"
@rendermode InteractiveServer
@attribute [Authorize]
@using SendgridParquetViewer.Models
@using SendgridParquetViewer.Services
@using ZLogger
@inject TimeProvider TimeProvider
@inject ILogger<Histogram> Logger
@inject IJSRuntime JsRuntime
@inject S3StorageService S3StorageService
@implements IAsyncDisposable

<PageTitle>SendGrid Events Histogram</PageTitle>

<h1>SendGrid Events Histogram</h1>

<div style="padding: 20px; background-color: #f8f9fa; border-radius: 8px; margin-bottom: 20px;">
    <h3>検索条件</h3>

    <!-- Search Form with Flow Layout -->
    <FluentStack Orientation="Orientation.Horizontal" Wrap="true" Style="gap: 20px; align-items: flex-start;">

        <!-- Email Address Field -->
        <div style="min-width: 250px;">
            <FluentTextField @bind-Value="_selectedEmail" @onkeydown="OnEmailKeyDown" Label="email（LIKE句）" Style="width: 100%;" Placeholder="example@domain.com" />
        </div>

        <!-- SG Template ID Field -->
        <div style="min-width: 250px;">
            <FluentTextField @bind-Value="_selectedSgTemplateId" Label="sg_template_id（完全一致）" Style="width: 100%;" Placeholder="d-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx" />
        </div>

        <!-- Event Type Selection -->
        <div style="min-width: 200px;">
            <FluentLabel>イベントタイプ</FluentLabel>
            <FluentSelect TOption="string" @bind-Value="_selectedEventType" Style="width: 100%; margin-top: 5px;">
                @foreach (var eventType in SendGridEventTypes.AllEventTypes)
                {
                    <FluentOption TOption="string" Value="@eventType.Value">@eventType.Display</FluentOption>
                }
            </FluentSelect>
        </div>

        <div style="min-width: 200px;">
            <FluentDatePicker @bind-Value="_selectedDate" Label="日付選択" Style="width: 100%;" />
            <FluentRadioGroup @bind-Value="_dateSelectionMode" Style="margin-top: 5px;">
                <FluentRadio Value="@DateSelectionMode.YearMonth">年月のみ使用（日付は無視）</FluentRadio>
                <FluentRadio Value="@DateSelectionMode.YearMonthDay">年月日すべて使用</FluentRadio>
            </FluentRadioGroup>
        </div>

        <!-- Search Button -->
        <div style="margin-top: 25px;">
            <FluentButton Appearance="Appearance.Accent" OnClick="RunQueryAsync" disabled="@_isExecuting">
                @(_isExecuting ? "Running..." : "検索")
            </FluentButton>
        </div>

    </FluentStack>
</div>

@* ヒストグラム表示 *@
<div class="mt-3" @ref="_histogramHost"></div>

@code {
    // Enum for date selection mode
    public enum DateSelectionMode
    {
        YearMonth,
        YearMonthDay
    }

    private CancellationTokenSource _cts = new CancellationTokenSource();
    private bool _isExecuting;
    private ElementReference _histogramHost;
    private IJSObjectReference? _histogramModule;
    private IJSObjectReference? _histogramApp;

    // Search parameters
    private DateSelectionMode _dateSelectionMode = DateSelectionMode.YearMonthDay;
    private DateTime? _selectedDate = null;
    private string _selectedEmail = "";
    private string _selectedEventType = SendGridEventTypes.Delivered;
    private string _selectedSgTemplateId = "";

    protected override async Task OnInitializedAsync()
    {
        _selectedDate = TimeProvider.GetUtcNow().ToJst().AddDays(-3).DateTime;
        await base.OnInitializedAsync();
    }

    private async Task OnEmailKeyDown(KeyboardEventArgs args)
    {
        if (!string.Equals(args.Key, "Enter", StringComparison.OrdinalIgnoreCase))
        {
            return;
        }

        if (_isExecuting)
        {
            return;
        }

        await RunQueryAsync();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await EnsureHistogramAppAsync();
        }
    }

    private async ValueTask<IJSObjectReference?> EnsureHistogramAppAsync()
    {
        if (_histogramApp is not null)
        {
            return _histogramApp;
        }

        if (_histogramModule is null)
        {
            Logger.ZLogDebug($"JsRuntime.InvokeAsync import ./duckdb/duckdb-browser-bundle.js");
            _histogramModule = await JsRuntime.InvokeAsync<IJSObjectReference>("import", "./duckdb/duckdb-browser-bundle.js");
        }

        var options = new DuckDbWasmOptions();
        var config = new
        {
            bundleBasePath = options.BundleBasePath,
            mainModule = options.MainModule,
            mainWorker = options.MainWorker,
            moduleLoader = options.ModuleLoader,
            pthreadWorker = string.IsNullOrWhiteSpace(options.PthreadWorker) ? null : options.PthreadWorker
        };

        Logger.ZLogDebug($"JsRuntime.InvokeAsync createHistogramApp");
        _histogramApp = await _histogramModule.InvokeAsync<IJSObjectReference>("createHistogramApp", _histogramHost, config);
        return _histogramApp;
    }

    private CancellationToken RenewCancellationToken()
    {
        var previous = _cts;
        _cts = new CancellationTokenSource();

        try
        {
            previous.Cancel();
        }
        finally
        {
            previous.Dispose();
        }

        return _cts.Token;
    }

    private async Task RunQueryAsync()
    {
        var histogramApp = await EnsureHistogramAppAsync();
        if (histogramApp is null)
        {
            return;
        }

        _isExecuting = true;
        StateHasChanged();

        try
        {
            var cancellationToken = RenewCancellationToken();

            IReadOnlyCollection<string> parquetUrls;
            parquetUrls = await GetParquetUrlsAsync(cancellationToken);

            var condition = new SearchCondition
            {
                Email = _selectedEmail,
                EventType = _selectedEventType,
                SgTemplateId = _selectedSgTemplateId,
                ParquetUrls = parquetUrls,
            };

            var mode = _dateSelectionMode == DateSelectionMode.YearMonthDay ? "day" : "month";
            var targetDate = new
            {
                year = _selectedDate?.Year ?? DateTime.Now.Year,
                month = _selectedDate?.Month ?? DateTime.Now.Month,
                day = _dateSelectionMode == DateSelectionMode.YearMonthDay ? _selectedDate?.Day : null
            };

            if (!cancellationToken.IsCancellationRequested)
            {
                await histogramApp.InvokeVoidAsync("runQuery", cancellationToken, condition, mode, targetDate);
            }
        }
        catch (OperationCanceledException)
        {
            return;
        }
        finally
        {
            _isExecuting = false;
        }
    }

    record struct YearMonthDayOptional(int? Year, int? Month, int? Day, int? Hour);

    /// <summary>
    /// 対象日・時間にあるファイル一覧の取得
    /// </summary>
    /// <returns></returns>
    private async Task<IReadOnlyCollection<string>> GetParquetUrlsAsync(CancellationToken ct)
    {
        var ymd = _dateSelectionMode switch
        {
            DateSelectionMode.YearMonthDay => new YearMonthDayOptional(_selectedDate?.Year, _selectedDate?.Month, _selectedDate?.Day, null),
            DateSelectionMode.YearMonth => new YearMonthDayOptional(_selectedDate?.Year, _selectedDate?.Month, null, null),
            _ => throw new ArgumentOutOfRangeException()
        };
        var s3CompactionPrefix = SendGridPathUtility.GetS3CompactionPrefix(ymd.Year, ymd.Month, ymd.Day, ymd.Hour);
        var keys = await S3StorageService.ListFilesAsync(s3CompactionPrefix, ct);
        var pathPrefix = S3PresigningTransformer.PathPrefix;
        return keys.Select(x => $"{pathPrefix}/{x}").ToArray();
    }

    public async ValueTask DisposeAsync()
    {
        if (!_cts.IsCancellationRequested)
        {
            _cts.Cancel();
        }
        _cts.Dispose();

        if (_histogramApp is not null)
        {
            try
            {
                await _histogramApp.InvokeVoidAsync("unmount");
            }
            catch (OperationCanceledException) { }
            catch (JSDisconnectedException) { }

            try
            {
                await _histogramApp.DisposeAsync();
            }
            catch (OperationCanceledException) { }
            catch (JSDisconnectedException) { }
        }

        if (_histogramModule is not null)
        {
            try
            {
                await _histogramModule.DisposeAsync();
            }
            catch (OperationCanceledException) { }
            catch (JSDisconnectedException) { }
        }
    }
}
