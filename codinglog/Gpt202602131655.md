# 作業ログ

## ユーザープロンプト
- review S3LockService 分散ロックの実装の正しさを評価してください
- 修正をお願いします

## 実施内容
- `S3LockService` の分散ロック解放処理を、無条件 `DELETE` から `ETag` 条件付き `PUT` (CAS) に変更。
  - 既存ロックの `LockId` 一致時のみ `ExpiresAt` を現在時刻へ更新して失効扱いにする。
  - 競合時 (`PreconditionFailed`) は他インスタンスの更新を尊重して解放をスキップ。
- `S3LockService` に `TryInvalidateExpiredLockAsync(LockInfo expectedLock, CancellationToken)` を追加。
  - 取得済みロック情報と現在のロック情報（`LockId`/`OwnerId`/`AcquiredAt`）が一致し、かつ期限切れの場合のみ CAS で失効更新。
- `CompactionService.CleanupExpiredLockAsync` を修正。
  - 期限切れロック検知後の `ForceDeleteLockAsync` を廃止し、`TryInvalidateExpiredLockAsync` に置換。
  - 競合で状態が変わった場合はスキップログを残す。
- `CompactionService.FinalizeStalledRunAsync` を修正。
  - 直接 `ReleaseLockAsync` せず、現在ロックを再取得して
    - `LockId` 一致
    - 期限切れ
    の場合のみ `TryInvalidateExpiredLockAsync` を実行する安全な流れに変更。

## 目的
- TOCTOU により「別インスタンスが取得した新しいロックを誤って削除する」競合を回避する。
- ロック更新の一貫性を `ETag` ベースの CAS に統一する。
